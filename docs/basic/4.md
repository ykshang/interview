# 跨域专题

## 1. CORS 跨源资源共享

简单来说 CORS 不需要前端人员配置，需要后端人员在响应头里加上以下报文，浏览器拿到返回的报文后就不在检查了。
缺点是需要后端人员配置指定的来源才能实现跨域

```http
// 说明了支持跨域的来源
Access-Control-Allow-Origin: http://foo.example
// 说明了支持的跨域方法
Access-Control-Allow-Methods: POST, GET, OPTIONS
// 说明了 将接受的自定义header字段名
Access-Control-Allow-Headers: X-PINGOTHER, Content-Type
// 预检请求的结果能够被缓存多久，即在多久内可以省略 预检请求 。
Access-Control-Max-Age: 86400
```

## 2. JSONP

JSONP（JSON with Padding）是一种传统的跨域解决方案，通过动态创建`<script>`标签来实现跨域请求，因为`<script>`标签不受同源策略的限制。  
需要前端人员封装一个回调函数，把回调函数名传递给后端，后端人员配合拿到相应数据后再把相应数据传递给前端，触发回调函数。
只能解决 get 请求的跨域，无法处理 delete、put、post 等请求。

```html
<!DOCTYPE html>
<html>
  <head>
    <title>JSONP Demo</title>
  </head>
  <body>
    <script>
      function handleResponse(data) {
        console.log("Received data:", data);
      }
      const script = document.createElement("script");
      script.src = "http://example.com/api?callback=handleResponse";
      document.body.appendChild(script);
    </script>
  </body>
</html>
```

```js
// 假设是Node.js后端
const http = require("http");
http
  .createServer((req, res) => {
    const callbackName = req.url.match(/callback=([^&]+)/)[1];
    const responseData = { message: "Hello, world!" };
    res.writeHead(200, { "Content-Type": "application/javascript" });
    res.end(`${callbackName}(${JSON.stringify(responseData)})`);
  })
  .listen(80, "example.com");
```

## 3. Proxy 代理

核心原理是在配置一个同源服务器去代理你的请求，来实现和后端服务器通信。  
因为浏览器和服务器之间有同源策略的限制，服务器和服务器之间没有。

### 1. nginx 服务器开启反向代理

用于生产环境，后端去配置，将前端服务部署的服务器配置到 nginx 上去

```nginx
## 如果你要请求的真实的url为：http://api.example2.com/login
## 在代码里写 /api/login 即可
server {
  listen 80;
  server_name example1.com;
  location /api {
    # 定义代理目标
    proxy_pass http://api.example2.com;
    # 允许跨域请求
    add_header Access-Control-Allow-Origin *;
    # 允许带身份验证信息的跨域请求
    add_header Access-Control-Allow-Credentials true;
    # 允许的请求方法
    add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
    # 允许的请求头
    add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
    # 预检请求的有效期
    add_header Access-Control-Max-Age 3600;
    # 处理 OPTIONS 请求
    if ($request_method = 'OPTIONS') {
      add_header Content-Type 'text/plain; charset=utf-8';
      add_header Content-Length 0;
      return 204;
    }
  }
}
```

### 2. vue-cli

主要用于开发环境下，解决开发过程中本地环境连接服务器的问题。

#### 1. `devServer.proxy` 所有请求转发到某个服务器的

```js
module.exports = {
  devServer: {
    proxy: "http://localhost:4000", // 目标地址
  },
};
```

#### 2. `http-proxy-middleware` 多个 api 分别匹配多个服务器

```js
module.exports = {
  devServer: {
    proxy: {
      "/req1": {
        target: "url1", //  请求变成 url1/req1
        ws: true,
        changeOrigin: true,
      },
      "/req2": {
        target: "url2", //  请求变成 url2/req2
      },
    },
  },
};
```
